{
  "metadata": {
    "title": "PWA + Tauri Mobile Architecture",
    "created": "2026-01-27T23:00:00Z",
    "updated": "2026-01-29T12:00:00Z",
    "project": "TPV El Haido",
    "status": "ready",
    "author": "WAXIN MK1 (AI Agent)",
    "user": "waxo (Marcos)"
  },
  "objectives": [
    "Consolidar detección de plataforma (isTauri) en un único lugar",
    "Conectar getPlatformService() con el resto del código",
    "Completar implementaciones stub de TauriPlatformService",
    "Separar frontend como PWA web standalone",
    "Preparar arquitectura para Tauri Mobile (iOS/Android)"
  ],
  "currentState": {
    "storageAdapters": {
      "status": "complete",
      "implementations": {
        "SqliteStorageAdapter": { "methods": "25/25", "tauriOnly": true },
        "HttpStorageAdapter": { "methods": "19/25", "hasFallback": true },
        "IndexedDbStorageAdapter": { "methods": "25/25", "pwaReady": true }
      },
      "interface": "IStorageAdapter",
      "notes": "Todos los adapters funcionan. HTTP missing: customers, tables, clearAllData, importData"
    },
    "platformAbstraction": {
      "status": "exists_but_unused",
      "location": "src/services/platform/",
      "files": [
        "PlatformService.ts (interface - 8 métodos)",
        "TauriPlatformService.ts (6/8 stubs con TODO)",
        "WebPlatformService.ts (8/8 implementados con fallbacks)",
        "PlatformDetector.ts (isTauri function)",
        "index.ts (getPlatformService factory)"
      ],
      "criticalIssue": "getPlatformService() NUNCA se usa en el código. Los componentes llaman a Tauri directamente."
    },
    "isTauriDetection": {
      "status": "scattered",
      "implementations": 5,
      "locations": [
        "src/services/platform/PlatformDetector.ts (canonical)",
        "src/utils/environment.ts (isTauriEnvironment)",
        "src/store/store.ts (local function)",
        "src/hooks/useAEATSidecar.ts (local function)",
        "src/services/http-storage-adapter.ts (__TAURI_IPC__ check)"
      ],
      "inlineChecks": [
        "src/components/VersionInfo.tsx",
        "src/components/Sections/Login.tsx"
      ]
    },
    "directTauriUsage": {
      "totalFiles": 16,
      "highCoupling": [
        "src/services/sqlite-storage-adapter.ts (all CRUD)",
        "src/services/thermal-printer.service.ts (shell + sidecar)",
        "src/components/LicenseDialog.tsx",
        "src/components/LicenseStatus.tsx",
        "src/components/LicenseSplashScreen.tsx"
      ],
      "mediumCoupling": [
        "src/hooks/useUpdater.ts",
        "src/lib/setupNativeMenu.ts",
        "src/components/Sections/SettingsPanel.tsx"
      ],
      "lowCoupling": [
        "src/services/http-storage-adapter.ts (has fallback)",
        "src/components/VersionInfo.tsx",
        "src/hooks/useScreenshot.ts"
      ]
    },
    "pwaReadiness": {
      "status": "zero",
      "missing": [
        "public/manifest.json",
        "public/sw.js",
        "PWA icons (192x192, 512x512)",
        "vite-plugin-pwa dependency",
        "Service worker registration"
      ],
      "existing": [
        "index.html meta tags (viewport, theme-color, description)",
        "logo.svg (but oversized at 789KB)"
      ]
    },
    "tauriMobileBlockers": [
      "AEAT sidecar (binaries can't run on mobile)",
      "Scattered isTauri() checks",
      "Direct invoke() calls in components",
      "No tauri-plugin-sql for mobile SQLite"
    ]
  },
  "architecture": {
    "diagram": "Components UI → getPlatformService() → [TauriPlatformService | WebPlatformService]\n                  ↓\n            Store (Zustand) → getStorageAdapter() → [SQLite | HTTP | IndexedDB]",
    "phases": [
      {
        "id": "phase0",
        "name": "Consolidación isTauri",
        "duration": "30m",
        "status": "pending",
        "priority": "critical"
      },
      {
        "id": "phase1",
        "name": "Conectar Platform Abstraction",
        "duration": "1h 30m",
        "status": "pending",
        "priority": "high"
      },
      {
        "id": "phase2",
        "name": "PWA Setup",
        "duration": "1h",
        "status": "pending",
        "priority": "high"
      },
      {
        "id": "phase3",
        "name": "Tauri Mobile Prep",
        "duration": "1h",
        "status": "pending",
        "priority": "medium"
      }
    ]
  },
  "tasks": [
    {
      "id": "consolidate-istauri",
      "title": "Consolidar todas las funciones isTauri()",
      "description": "Eliminar duplicados. Usar solo src/services/platform/PlatformDetector.ts como fuente única.",
      "phase": "phase0",
      "files": [
        "src/store/store.ts (eliminar local isTauri, importar de platform)",
        "src/hooks/useAEATSidecar.ts (eliminar local isTauri, importar de platform)",
        "src/components/VersionInfo.tsx (usar isPlatformTauri)",
        "src/components/Sections/Login.tsx (usar isPlatformTauri)",
        "src/utils/environment.ts (deprecar o re-exportar desde platform)"
      ],
      "complexity": "easy",
      "dependencies": []
    },
    {
      "id": "complete-tauri-platform-service",
      "title": "Completar TauriPlatformService stubs",
      "description": "Implementar los 6 métodos que son TODO/stubs",
      "phase": "phase1",
      "file": "src/services/platform/TauriPlatformService.ts",
      "methods": [
        "printTicket() → delegar a thermal-printer.service.ts",
        "printReceipt() → delegar a thermal-printer.service.ts",
        "openFileDialog() → usar @tauri-apps/plugin-dialog",
        "saveFileDialog() → usar @tauri-apps/plugin-dialog",
        "checkForUpdates() → usar código de useUpdater.ts",
        "downloadAndInstall() → usar código de useUpdater.ts"
      ],
      "complexity": "medium",
      "dependencies": ["consolidate-istauri"]
    },
    {
      "id": "integrate-platform-service-updater",
      "title": "Migrar useUpdater a PlatformService",
      "description": "useUpdater.ts debe usar getPlatformService() en lugar de importar Tauri directamente",
      "phase": "phase1",
      "file": "src/hooks/useUpdater.ts",
      "complexity": "easy",
      "dependencies": ["complete-tauri-platform-service"]
    },
    {
      "id": "integrate-platform-service-license",
      "title": "Abstraer llamadas de licencia",
      "description": "Crear LicenseService que use PlatformService para las operaciones de licencia",
      "phase": "phase1",
      "files": [
        "src/services/LicenseService.ts (nuevo)",
        "src/components/LicenseDialog.tsx",
        "src/components/LicenseStatus.tsx",
        "src/components/LicenseSplashScreen.tsx"
      ],
      "complexity": "medium",
      "dependencies": ["consolidate-istauri"]
    },
    {
      "id": "pwa-manifest",
      "title": "Crear PWA manifest.json",
      "description": "Manifest completo para PWA standalone con iconos y configuración",
      "phase": "phase2",
      "file": "public/manifest.json",
      "complexity": "easy",
      "dependencies": [],
      "code": {
        "language": "json",
        "content": "{\n  \"name\": \"TPV El Haido\",\n  \"short_name\": \"TPV Haido\",\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"background_color\": \"#000000\",\n  \"theme_color\": \"#000000\",\n  \"orientation\": \"portrait-primary\",\n  \"scope\": \"/\",\n  \"icons\": [\n    { \"src\": \"/icons/icon-192.png\", \"sizes\": \"192x192\", \"type\": \"image/png\" },\n    { \"src\": \"/icons/icon-512.png\", \"sizes\": \"512x512\", \"type\": \"image/png\" },\n    { \"src\": \"/icons/icon-512-maskable.png\", \"sizes\": \"512x512\", \"type\": \"image/png\", \"purpose\": \"maskable\" }\n  ]\n}"
      }
    },
    {
      "id": "pwa-icons",
      "title": "Generar iconos PWA",
      "description": "Crear set de iconos desde logo.svg (192, 512, maskable)",
      "phase": "phase2",
      "folder": "public/icons/",
      "complexity": "easy",
      "dependencies": []
    },
    {
      "id": "pwa-vite-plugin",
      "title": "Instalar y configurar vite-plugin-pwa",
      "description": "Añadir plugin PWA a Vite con estrategia de caching",
      "phase": "phase2",
      "files": ["package.json", "vite.config.ts"],
      "complexity": "easy",
      "dependencies": ["pwa-manifest", "pwa-icons"],
      "code": {
        "language": "typescript",
        "content": "import { VitePWA } from 'vite-plugin-pwa'\n\nexport default defineConfig({\n  plugins: [\n    solid(),\n    tailwindcss(),\n    VitePWA({\n      registerType: 'autoUpdate',\n      includeAssets: ['logo.svg', 'icons/*.png'],\n      manifest: false, // usamos el nuestro\n      workbox: {\n        globPatterns: ['**/*.{js,css,html,svg,png,woff2}'],\n        runtimeCaching: [\n          {\n            urlPattern: /^https:\\/\\/fonts\\.googleapis\\.com/,\n            handler: 'CacheFirst',\n            options: { cacheName: 'google-fonts' }\n          }\n        ]\n      }\n    })\n  ]\n})"
      }
    },
    {
      "id": "pwa-index-html",
      "title": "Actualizar index.html para PWA",
      "description": "Añadir link a manifest y meta tags faltantes",
      "phase": "phase2",
      "file": "index.html",
      "complexity": "easy",
      "dependencies": ["pwa-manifest"],
      "additions": [
        "<link rel=\"manifest\" href=\"/manifest.json\" />",
        "<meta name=\"apple-mobile-web-app-capable\" content=\"yes\" />",
        "<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\" />",
        "<meta name=\"apple-mobile-web-app-title\" content=\"TPV El Haido\" />"
      ]
    },
    {
      "id": "tauri-mobile-init",
      "title": "Inicializar targets Tauri Mobile",
      "description": "Ejecutar tauri ios init y tauri android init",
      "phase": "phase3",
      "complexity": "easy",
      "dependencies": ["consolidate-istauri"],
      "commands": [
        "bun tauri ios init",
        "bun tauri android init"
      ]
    },
    {
      "id": "tauri-mobile-sql-plugin",
      "title": "Añadir tauri-plugin-sql para mobile",
      "description": "Configurar SQLite plugin que funciona en iOS/Android",
      "phase": "phase3",
      "files": ["src-tauri/Cargo.toml", "src-tauri/tauri.conf.json"],
      "complexity": "medium",
      "dependencies": ["tauri-mobile-init"]
    },
    {
      "id": "aeat-api-fallback",
      "title": "Crear fallback API para AEAT en mobile",
      "description": "El sidecar AEAT no funciona en mobile. Crear servicio que delegue a API remota.",
      "phase": "phase3",
      "file": "src/services/AEATService.ts",
      "complexity": "medium",
      "dependencies": ["consolidate-istauri"]
    }
  ],
  "parallelization": {
    "canParallel": [
      ["pwa-manifest", "pwa-icons"],
      ["integrate-platform-service-updater", "integrate-platform-service-license"],
      ["tauri-mobile-init", "pwa-vite-plugin"]
    ],
    "sequential": [
      ["consolidate-istauri", "complete-tauri-platform-service", "integrate-platform-service-updater"],
      ["pwa-manifest", "pwa-index-html"],
      ["tauri-mobile-init", "tauri-mobile-sql-plugin"]
    ]
  },
  "estimatedTotal": "4h",
  "quickWins": [
    "consolidate-istauri (30min) - elimina deuda técnica inmediatamente",
    "pwa-manifest + pwa-icons (30min) - hace la app instalable en browsers",
    "pwa-vite-plugin (15min) - activa service worker automático"
  ]
}
