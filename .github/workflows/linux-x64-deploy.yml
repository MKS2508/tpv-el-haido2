name: ðŸ§ Linux x64 Deploy

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux-x64:
    name: ðŸ—ï¸ Build for Linux x64
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          libappindicator3-dev \
          librsvg2-dev \
          patchelf \
          libssl-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev

    - name: ðŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: ðŸ“¦ Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: src-tauri

    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”§ Install Node dependencies
      run: npm ci

    - name: ðŸ§ Build Tauri application for Linux x64
      env:
        TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      run: |
        echo "ðŸš€ Building Tauri application for Linux x64..."
        npx tauri build
        echo "âœ… Build completed successfully"

    - name: ðŸ“Š List generated artifacts
      run: |
        echo "ðŸ“Š Generated artifacts:"
        ls -la src-tauri/target/release/ | head -20
        echo ""
        echo "ðŸ“¦ Bundles:"
        find src-tauri/target/release/bundle -type f -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" -o -name "*.sig" 2>/dev/null || true

    - name: ðŸ“ Generate OTA update manifest
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "ðŸ“ Generating latest.json for OTA updates..."

        VERSION="${GITHUB_REF#refs/tags/v}"
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        # Find signature files
        DEB_SIG=$(find src-tauri/target/release/bundle -name "*.deb.sig" -type f | head -1)
        APPIMAGE_SIG=$(find src-tauri/target/release/bundle -name "*.AppImage.sig" -type f | head -1)

        DEB_SIGNATURE=""
        APPIMAGE_SIGNATURE=""

        if [ -f "$DEB_SIG" ]; then
          DEB_SIGNATURE=$(cat "$DEB_SIG")
        fi

        if [ -f "$APPIMAGE_SIG" ]; then
          APPIMAGE_SIGNATURE=$(cat "$APPIMAGE_SIG")
        fi

        REPO="${{ github.repository }}"
        DEB_NAME=$(basename src-tauri/target/release/bundle/deb/*.deb 2>/dev/null || echo "")
        APPIMAGE_NAME=$(basename src-tauri/target/release/bundle/appimage/*.AppImage 2>/dev/null || echo "")

        cat > latest-x64.json << EOF
        {
          "version": "${VERSION}",
          "notes": "Release ${VERSION}",
          "pub_date": "${DATE}",
          "platforms": {
            "linux-x86_64": {
              "signature": "${APPIMAGE_SIGNATURE:-$DEB_SIGNATURE}",
              "url": "https://github.com/${REPO}/releases/download/v${VERSION}/${APPIMAGE_NAME:-$DEB_NAME}"
            }
          }
        }
        EOF

        echo "âœ… latest-x64.json generated:"
        cat latest-x64.json

    - name: ðŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-x64-build
        path: |
          src-tauri/target/release/tpv-el-haido
          src-tauri/target/release/bundle/deb/*.deb
          src-tauri/target/release/bundle/rpm/*.rpm
          src-tauri/target/release/bundle/appimage/*.AppImage
          src-tauri/target/release/bundle/**/*.sig
        retention-days: 30

    - name: ðŸš€ Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          src-tauri/target/release/tpv-el-haido
          src-tauri/target/release/bundle/deb/*.deb
          src-tauri/target/release/bundle/rpm/*.rpm
          src-tauri/target/release/bundle/appimage/*.AppImage
          src-tauri/target/release/bundle/**/*.sig
          latest-x64.json
        body: |
          # ðŸ§ TPV El Haido - Linux x64 Release

          ## ðŸ“¦ Installation Options:

          ### Option 1: AppImage (Recommended - Portable)
          ```bash
          chmod +x "TPV El Haido_${{ github.ref_name }}_amd64.AppImage"
          ./"TPV El Haido_${{ github.ref_name }}_amd64.AppImage"
          ```

          ### Option 2: DEB Package (Debian/Ubuntu)
          ```bash
          sudo dpkg -i "tpv-el-haido_${{ github.ref_name }}_amd64.deb"
          sudo apt-get install -f  # Fix dependencies if needed
          ```

          ### Option 3: Direct Executable
          ```bash
          chmod +x tpv-el-haido
          ./tpv-el-haido
          ```

          ---
          ðŸ§ *Built for Linux x64* | ðŸ¤– *Built with GitHub Actions*
        draft: false
        prerelease: false

  # Optional: Docker build
  build-docker:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: tpv-el-haido:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          TAURI_SIGNING_PRIVATE_KEY=${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

    - name: ðŸ“¦ Extract artifacts from Docker
      run: |
        docker create --name extract tpv-el-haido:latest
        docker cp extract:/output ./docker-artifacts
        docker rm extract
        ls -la ./docker-artifacts/

    - name: ðŸ“¦ Upload Docker artifacts
      uses: actions/upload-artifact@v4
      with:
        name: docker-build-artifacts
        path: docker-artifacts/
        retention-days: 30
