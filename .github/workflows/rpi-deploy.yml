name: ðŸ“ RPi ARM64 Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-rpi:
    name: ðŸ—ï¸ Build for Raspberry Pi 3 (ARM64)
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ¦€ Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: aarch64-unknown-linux-gnu
        override: true
        components: rustfmt, clippy

    - name: ðŸ“¦ Install cross-compilation dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ”§ Install Node dependencies
      run: npm ci

    - name: ðŸŽ¨ Install ImageMagick for icons
      run: sudo apt-get install -y imagemagick

    - name: ðŸ”§ Configure Cargo for cross-compilation
      run: |
        mkdir -p .cargo
        cat > .cargo/config.toml << EOF
        [target.aarch64-unknown-linux-gnu]
        linker = "aarch64-linux-gnu-gcc"
        EOF

    - name: ðŸ—ï¸ Build frontend
      run: npm run build

    - name: ðŸ“ Cross-compile for ARM64/RPi3
      run: |
        npm run tauri build -- --target aarch64-unknown-linux-gnu
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}

    - name: ðŸ”§ Setup Bun runtime
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: ðŸ“‹ Generate documentation
      run: |
        bun run generate-docs.ts

    - name: ðŸ“Š Check generated files
      run: |
        ls -la src-tauri/target/aarch64-unknown-linux-gnu/release/
        ls -la src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/deb/ || echo "DEB not found"
        ls -la src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/rpm/ || echo "RPM not found"

    - name: ðŸ“¦ Upload RPi executables
      uses: actions/upload-artifact@v4
      with:
        name: tpv-el-haido-rpi3-executables
        path: |
          src-tauri/target/aarch64-unknown-linux-gnu/release/tpv-el-haido
          src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/deb/*.deb
          src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/rpm/*.rpm
        if-no-files-found: warn

    - name: ðŸ“š Upload documentation and MD files
      uses: actions/upload-artifact@v4
      with:
        name: tpv-el-haido-rpi3-documentation
        path: |
          RPi-Build-Documentation.md
          README.md
          generate-docs.ts
          rpi-explorer.ts
          rpi-builder-cli.tsx
        if-no-files-found: warn

  create-release:
    name: ðŸš€ Create GitHub Release  
    needs: build-rpi
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ðŸ”¢ Generate release version
      id: version
      run: |
        VERSION="v0.1.0-$(date +%Y%m%d)-$(echo $GITHUB_SHA | cut -c1-7)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"

    - name: ðŸ·ï¸ Create Release Tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a ${{ steps.version.outputs.version }} -m "RPi ARM64 Release ${{ steps.version.outputs.version }}"
        git push origin ${{ steps.version.outputs.version }}

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "ðŸ“ TPV El Haido RPi3 Release ${{ steps.version.outputs.version }}"
        body: |
          # ðŸ“ TPV El Haido - Raspberry Pi 3 ARM64 Release
          
          ## ðŸ“± Archivos para Raspberry Pi 3
          
          ### ðŸ“¦ InstalaciÃ³n (Recomendado)
          ```bash
          # Descargar e instalar DEB
          sudo dpkg -i TPV\ El\ Haido_0.1.0_arm64.deb
          sudo apt-get install -f
          ```
          
          ### ðŸ”§ Ejecutable Directo  
          ```bash
          # Descargar y ejecutar
          chmod +x tpv-el-haido
          ./tpv-el-haido
          ```
          
          ## ðŸ“Š Artefactos Incluidos
          - **DEB Package** (21MB) - Para instalaciÃ³n con dpkg
          - **RPM Package** (21MB) - Para sistemas con rpm
          - **Ejecutable ARM64** (34.7MB) - Ejecutable directo
          - **DocumentaciÃ³n** - GuÃ­a completa de compilaciÃ³n
          
          ## ðŸŽ¯ Compatibilidad
          - âœ… Raspberry Pi 3 (ARM64)
          - âœ… Raspberry Pi 4 (ARM64)
          - âœ… Otros sistemas ARM64 Linux
          
          ---
          *ðŸ¤– Generado automÃ¡ticamente con GitHub Actions*
        files: |
          artifacts/tpv-el-haido-rpi3-executables/*
          artifacts/tpv-el-haido-rpi3-documentation/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¢ Summary
      run: |
        echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ RPi3 ARM64 Build: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Executables compiled for aarch64-unknown-linux-gnu" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… DEB and RPM packages generated" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Documentation included" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… GitHub Release created with artifacts" >> $GITHUB_STEP_SUMMARY